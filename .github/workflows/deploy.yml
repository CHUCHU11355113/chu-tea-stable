# Chu Tea ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å·¥ä½œæµ
# æ­¤æ–‡ä»¶åº”æ”¾ç½®åœ¨ chu-tea-stable ä»“åº“çš„ .github/workflows/deploy.yml
#
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯
# åŠŸèƒ½ï¼šæ„å»ºé¡¹ç›®å¹¶é€šè¿‡è“ç»¿éƒ¨ç½²æ–¹å¼éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨

name: ğŸš€ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
      # ============================================
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # ============================================
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # ============================================
      # æ­¥éª¤ 2: è®¾ç½® Node.js ç¯å¢ƒ
      # ============================================
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ============================================
      # æ­¥éª¤ 3: è®¾ç½® pnpm
      # ============================================
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      # ============================================
      # æ­¥éª¤ 4: è·å– pnpm ç¼“å­˜ç›®å½•
      # ============================================
      - name: ğŸ“ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # ============================================
      # æ­¥éª¤ 5: è®¾ç½® pnpm ç¼“å­˜
      # ============================================
      - name: ğŸ’¾ Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # ============================================
      # æ­¥éª¤ 6: å®‰è£…ä¾èµ–
      # ============================================
      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # ============================================
      # æ­¥éª¤ 7: æ„å»ºé¡¹ç›®
      # ============================================
      - name: ğŸ”¨ Build project
        run: pnpm build
        env:
          NODE_ENV: production

      # ============================================
      # æ­¥éª¤ 8: å‡†å¤‡éƒ¨ç½²åŒ…
      # ============================================
      - name: ğŸ“¦ Prepare deployment package
        run: |
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p deploy-package
          
          # å¤åˆ¶æ„å»ºäº§ç‰©
          cp -r dist deploy-package/
          cp -r server deploy-package/
          cp package.json deploy-package/
          cp pnpm-lock.yaml deploy-package/
          
          # åˆ›å»ºéƒ¨ç½²ä¿¡æ¯æ–‡ä»¶
          echo "{
            \"version\": \"$(date +%Y%m%d%H%M%S)\",
            \"commit\": \"${{ github.sha }}\",
            \"branch\": \"${{ github.ref_name }}\",
            \"deployed_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
          }" > deploy-package/deploy-info.json
          
          # æ‰“åŒ…
          tar -czf deploy-package.tar.gz deploy-package

      # ============================================
      # æ­¥éª¤ 9: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      # ============================================
      - name: ğŸš€ Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        env:
          DEPLOY_PACKAGE: deploy-package.tar.gz
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: DEPLOY_PACKAGE
          script: |
            set -e
            
            # å˜é‡å®šä¹‰
            APP_DIR="/home/ubuntu/chu-tea"
            RELEASES_DIR="$APP_DIR/releases"
            SHARED_DIR="$APP_DIR/shared"
            RELEASE_NAME=$(date +%Y%m%d%H%M%S)
            NEW_RELEASE_DIR="$RELEASES_DIR/$RELEASE_NAME"
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²ç‰ˆæœ¬: $RELEASE_NAME"
            
            # åˆ›å»ºæ–°ç‰ˆæœ¬ç›®å½•
            mkdir -p "$NEW_RELEASE_DIR"
            
            echo "ğŸ“¦ ç­‰å¾…éƒ¨ç½²åŒ…ä¸Šä¼ ..."

      # ============================================
      # æ­¥éª¤ 10: ä¸Šä¼ éƒ¨ç½²åŒ…
      # ============================================
      - name: ğŸ“¤ Upload deployment package
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "deploy-package.tar.gz"
          target: "/tmp/"

      # ============================================
      # æ­¥éª¤ 11: æ‰§è¡Œéƒ¨ç½²
      # ============================================
      - name: ğŸ”„ Execute deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            
            # å˜é‡å®šä¹‰
            APP_DIR="/home/ubuntu/chu-tea"
            RELEASES_DIR="$APP_DIR/releases"
            SHARED_DIR="$APP_DIR/shared"
            RELEASE_NAME=$(date +%Y%m%d%H%M%S)
            NEW_RELEASE_DIR="$RELEASES_DIR/$RELEASE_NAME"
            
            echo "ğŸ“¦ è§£å‹éƒ¨ç½²åŒ…..."
            mkdir -p "$NEW_RELEASE_DIR"
            tar -xzf /tmp/deploy-package.tar.gz -C /tmp/
            cp -r /tmp/deploy-package/* "$NEW_RELEASE_DIR/"
            rm -rf /tmp/deploy-package /tmp/deploy-package.tar.gz
            
            echo "ğŸ”— åˆ›å»ºå…±äº«æ–‡ä»¶ç¬¦å·é“¾æ¥..."
            # é“¾æ¥ .env æ–‡ä»¶
            if [ -f "$SHARED_DIR/.env" ]; then
                ln -sf "$SHARED_DIR/.env" "$NEW_RELEASE_DIR/.env"
            fi
            
            # é“¾æ¥æ—¥å¿—ç›®å½•
            if [ -d "$SHARED_DIR/logs" ]; then
                ln -sf "$SHARED_DIR/logs" "$NEW_RELEASE_DIR/logs"
            fi
            
            # é“¾æ¥ä¸Šä¼ ç›®å½•
            if [ -d "$SHARED_DIR/uploads" ]; then
                ln -sf "$SHARED_DIR/uploads" "$NEW_RELEASE_DIR/uploads"
            fi
            
            echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
            cd "$NEW_RELEASE_DIR"
            pnpm install --prod --frozen-lockfile
            
            echo "ğŸ”„ åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬..."
            # åŸå­æ€§åˆ‡æ¢ç¬¦å·é“¾æ¥
            ln -sfn "$NEW_RELEASE_DIR" "$APP_DIR/current"
            
            echo "ğŸ”„ é‡è½½æœåŠ¡..."
            # é‡è½½ Nginx
            sudo nginx -s reload
            
            # é‡è½½ PM2 (é›¶åœæœº)
            cd "$APP_DIR"
            if pm2 list | grep -q "chu-tea-backend"; then
                pm2 reload ecosystem.config.js --update-env
            else
                pm2 start ecosystem.config.js
            fi
            pm2 save
            
            echo "ğŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬ (ä¿ç•™æœ€è¿‘5ä¸ª)..."
            cd "$RELEASES_DIR"
            ls -t | tail -n +6 | xargs -r rm -rf
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸ“‹ å½“å‰ç‰ˆæœ¬: $RELEASE_NAME"
            echo "ğŸ”— ç¬¦å·é“¾æ¥: $(readlink -f $APP_DIR/current)"

      # ============================================
      # æ­¥éª¤ 12: å¥åº·æ£€æŸ¥
      # ============================================
      - name: ğŸ¥ Health check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5
            
            # æ£€æŸ¥ Nginx
            if systemctl is-active --quiet nginx; then
                echo "âœ… Nginx è¿è¡Œæ­£å¸¸"
            else
                echo "âŒ Nginx æœªè¿è¡Œ"
                exit 1
            fi
            
            # æ£€æŸ¥ PM2
            if pm2 list | grep -q "online"; then
                echo "âœ… PM2 åº”ç”¨è¿è¡Œæ­£å¸¸"
            else
                echo "âŒ PM2 åº”ç”¨æœªè¿è¡Œ"
                exit 1
            fi
            
            # æ£€æŸ¥ HTTP å“åº”
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80 || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
                echo "âœ… HTTP å“åº”æ­£å¸¸ (çŠ¶æ€ç : $HTTP_STATUS)"
            else
                echo "âš ï¸ HTTP å“åº”å¼‚å¸¸ (çŠ¶æ€ç : $HTTP_STATUS)"
            fi
            
            echo "ğŸ‰ éƒ¨ç½²éªŒè¯å®Œæˆï¼"

      # ============================================
      # æ­¥éª¤ 13: éƒ¨ç½²é€šçŸ¥ (å¯é€‰)
      # ============================================
      - name: ğŸ“¢ Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "æäº¤: ${{ github.sha }}"
            echo "åˆ†æ”¯: ${{ github.ref_name }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
            echo "è¯·æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
          fi
